% !TEX root=../main.tex

%% Helpers %%

\newif\ifstateful
\statefulfalse
\newcommand*{\st}[1]
  {\ifstateful, #1\else\fi}


%% Typing %%

\newcommand*{\RelationT}
  {\Gamma\st{\Sigma} \infers e : \tau}

\newcommand*{\TPure}
  {\inferrule*[lab=T-Pure]
    {\Gamma\st{\Sigma} \infers e : \tau}
    {\Gamma\st{\Sigma} \infers `e : \Task \tau}}

\newcommand*{\TFail}
  {\inferrule*[lab=T-Fail]
    {\ }
    {\Gamma\st{\Sigma} \infers \Fail : \Task \tau}}

\newcommand*{\TEdit}
  {\inferrule*[lab=T-Edit]
    {\Gamma\st{\Sigma} \infers v : \tau}
    {\Gamma\st{\Sigma} \infers \Edit v : \Task \tau}}

\newcommand*{\TEmpty}
  {\inferrule*[lab=T-Empty]
    {\ }
    {\Gamma\st{\Sigma} \infers \Empty \tau : \Task \tau}}

\newcommand*{\TWatch}
  {\inferrule*[lab=T-Watch]
    {\Gamma, \Sigma \infers \Sigma(l) : \tau}
    {\Gamma, \Sigma \infers \Watch l : \Task \tau}}

\newcommand*{\TSeq}
  {\inferrule*[lab=T-Seq]
    {\Gamma\st{\Sigma} \infers t_1 : \Task \tau_1 \\
     \Gamma\st{\Sigma} \infers e : \tau_1 \to \Task \tau_2}
    {\Gamma\st{\Sigma} \infers t_1 \Seq e : \Task \tau_2}}

\newcommand*{\TAnd}
  {\inferrule*[lab=T-And]
    {\Gamma\st{\Sigma} \infers t_1 : \Task \tau_1 \\
     \Gamma\st{\Sigma} \infers t_2 : \Task \tau_2}
    {\Gamma\st{\Sigma} \infers t_1 \And t_2 : \Task (\tau_1 \times \tau_2)}}

\newcommand*{\TOr}
  {\inferrule*[lab=T-Or]
    {\Gamma\st{\Sigma} \infers t_1 : \Task \tau \\
     \Gamma\st{\Sigma} \infers t_2 : \Task \tau }
    {\Gamma\st{\Sigma} \infers t_1 \Or t_2 : \Task \tau}}


%% Evaluation %%

\newcommand*{\RelationV}
  {e \downto v}


%% Normalisation %%

\newcommand*{\RelationN}
  {t\st{s} \normalise t'\st{s'}}

\newcommand*{\NPure}
  {\inferrule*[lab=N-Pure]
    { }
    {`v\st{s} \normalise `v\st{s}}}

\newcommand*{\NFail}
  {\inferrule*[lab=N-Fail]
    { }
    {\Fail\st{s} \normalise \Fail\st{s}}}

\newcommand*{\NEdit}
  {\inferrule*[lab=N-Edit]
    { }
    {\Edit v\st{s} \normalise \Edit v\st{s}}}

\newcommand*{\NEmpty}
  {\inferrule*[lab=N-Empty]
    { }
    {\Empty \tau\st{s} \normalise \Empty \tau\st{s}}}

\newcommand*{\NWatch}
  {\inferrule*[lab=N-Watch]
    { }
    {\Watch l\st{s} \normalise \Watch l\st{s}}}

\newcommand*{\NSeq}
  {\inferrule*[lab=N-Seq,right={$t_1' = `v$}]
    {t_1\st{s} \normalise t_1'\st{s'}   \\
     e\ v \downto t_2       \\
     t_2\st{s'} \normalise t_2'\st{s''} }
    {t_1 \Seq e\st{s} \normalise t_2'\st{s''}}}

\newcommand*{\NSeqEval}
  {\inferrule*[lab=N-SeqEval,right={$t_1' \neq `v$}]
    {t_1\st{s} \normalise t_1'\st{s'}}
    {t_1 \Seq e\st{s} \normalise t_1' \Seq e\st{s'}}}

\newcommand*{\NAnd}
  {\inferrule*[lab=N-And,right={$t_1' = `v_1 \land t_2' = `v_2$}]
    {t_1\st{s}  \normalise t_1'\st{s'}  \\
     t_2\st{s'} \normalise t_2'\st{s''} }
    {t_1 \And t_2\st{s} \normalise \{`v_1, `v_2\}\st{s}}}

\newcommand*{\NAndEval}
  {\inferrule*[lab=N-AndEval,right={$t_1' \neq `v_1 \lor t_2' \neq `v_2$}]
    {t_1\st{s}  \normalise t_1'\st{s'}  \\
     t_2\st{s'} \normalise t_2'\st{s''} }
    {t_1 \And t_2\st{s} \normalise t_1' \And t_2'\st{s}}}

\newcommand*{\NOrEval}
  {\inferrule*[lab=N-OrEval]%,right={$t_1' \neq `v_1 \land t_2' \neq `v_2$}]
    {t_1\st{s}  \normalise t_1'\st{s'}  \\
     t_2\st{s'} \normalise t_2'\st{s''} }
    {t_1 \Or t_2\st{s} \normalise t_1' \Or t_2'\st{s}}}


%% Handling %%

\newcommand*{\RelationH}
  {t\st{s} \handle{\eta} t'\st{s'}}

\newcommand*{\HChange}
  {\inferrule*[lab=H-Change,right={$v, v' : \tau$}]
    { }
    {\Edit v\st{s} \handle{v'} \Edit v'\st{s}}}

\newcommand*{\HClear}
  {\inferrule*[lab=H-Clear]
    { }
    {\Edit v\st{s} \handle{\Clear} \Empty\st{s}}}

\newcommand*{\HEnter}
  {\inferrule*[lab=H-Enter,right={$v' : \tau$}]
    { }
    {\Empty \tau\st{s} \handle{v'} \Edit v'\st{s}}}

\newcommand{\HStore}
  {\inferrule*[lab=H-Store,right={$\Sigma(l), v' : \tau$}]
    { }
    {\Watch l, s \handle{v'} \Watch l, [l \mapsto v']s}}

\newcommand*{\HSeqStay}
  {\inferrule*[lab=H-SeqStay,right={$\Value(t_1) = \nothing$}]
    { }
    {t_1 \Seq e\st{s} \handle{\Next} t_1 \Seq e\st{s}}}

\newcommand*{\HSeqNext}
  {\inferrule*[lab=H-SeqNext,right={$\Value(t_1) = v$}]
    {e\ v \downto t_2    \\
     t_2\st{s} \normalise t_2'\st{s'} }
    {t_1 \Seq e\st{s} \handle{\Next} t_2' \Seq e\st{s'}}}

\newcommand*{\HPass}
  {\inferrule*[lab=H-Pass,right={$\eta \neq \Next$}]
    {t_1\st{s} \handle{\eta} t_1'\st{s'}}
    {t_1 \Seq e\st{s} \handle{\eta} t_1' \Seq e\st{s'}}}

\newcommand*{\AndOr}{\Both}

\newcommand*{\HLeft}
  {\inferrule*[lab=H-Left]
    {t_1\st{s} \handle{\eta} t_1'\st{s'} }
    {t_1 \AndOr t_2\st{s} \handle{\Left \eta} t_1' \AndOr t_2\st{s'}}}

\newcommand*{\HRight}
  {\inferrule*[lab=H-Right]
    {t_2\st{s} \handle{\eta} t_2'\st{s'} }
    {t_1\st{s} \AndOr t_2 \handle{\Left \eta} t_1 \AndOr t_2'\st{s'}}}


\endinput

\newcommand*{\}
  {\inferrule*[lab=]
    {}
    {}}
