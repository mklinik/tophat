% !TEX root=main.tex


%% Helpers %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newmacro{newrule}[4][2]
  {\newmacro{#1}{\inferrule*[lab={#1},right={$#2$}]
    {#3}
    {#4}}}
\newmacro{userule}
  {\usemacro}
\newmacro{refrule}[1]
  {\ifthenelse{\isundefined{#1}}
    {\GenericError{}{Rule `#1` is not defined}{}{}}
    {\textsc{#1}}}


\newif\ifstateful
\statefulfalse
\newmacro{st}[1]
  {\ifstateful{, #1}\else{}\fi}



%% Typing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationT}
  {\Gamma\st{\Sigma} \infers e : \tau}


\newrule{T-Edit}
  {\Gamma\st{\Sigma} \infers e : \beta}
  {\Gamma\st{\Sigma} \infers \Edit e : \Task \beta}


\newrule{T-Fill}
  {\ }
  {\Gamma\st{\Sigma} \infers \Fill \beta : \Task \beta}


\newrule{T-Change}
  {\Gamma, \Sigma \infers e : \beta}
  {\Gamma, \Sigma \infers \Change e : \Task \beta}


\newrule{T-Fail}
  { }
  {\Gamma\st{\Sigma} \infers \Fail : \forall\alpha. \Task \alpha}


\newrule{T-Next}
  {\Gamma\st{\Sigma} \infers e_1 : \Task \tau_1 \\
   \Gamma\st{\Sigma} \infers e_2 : \tau_1 \to \Task \tau_2}
  {\Gamma\st{\Sigma} \infers e_1 \Next e_2 : \Task \tau_2}


\newrule{T-Then}
  {\Gamma\st{\Sigma} \infers e_1 : \Task \tau_1 \\
   \Gamma\st{\Sigma} \infers e_2 : \tau_1 \to \Task \tau_2}
  {\Gamma\st{\Sigma} \infers e_1 \Then e_2 : \Task \tau_2}


\newrule{T-All}
  {\Gamma\st{\Sigma} \infers e_1 : \Task \tau_1 \\
   \Gamma\st{\Sigma} \infers e_2 : \Task \tau_2}
  {\Gamma\st{\Sigma} \infers e_1 \And e_2 : \Task\,(\tau_1 \times \tau_2)}


\newrule{T-One}
  {\Gamma\st{\Sigma} \infers e_1 : \Task \tau \\
   \Gamma\st{\Sigma} \infers e_2 : \Task \tau }
  {\Gamma\st{\Sigma} \infers e_1 \Xor e_2 : \Task \tau}



%% Evaluation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationV}
  {e \evaluate v}


\newrule{E-Edit}
  {e \evaluate v}
  {\Edit e \evaluate \Edit v}


\newrule{E-Fill}
  {\ }
  {\Fill \beta \evaluate \Fill \beta}


\newrule{E-Fail}
  { }
  {\Fail \evaluate \Fail}


\newrule{E-Then}
  {e_1 \evaluate t_1}
  {e_1 \Then e_2 \evaluate t_1 \Then e_2}



%% Normalisation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationN}
  {t\st{s} \normalise t'\st{s'}}


\newrule{N-Edit}
  { }
  {\Edit v \normalise \Edit v}


\newrule{N-Fill}
  { }
  {\Fill \beta \normalise \Fill \beta}


\newrule{N-Fail}
  { }
  {\Fail \normalise \Fail}


\newrule{N-ThenStay}[\Value(t_1') = \bot]
  {t_1\st{s} \normalise t_1'\st{s'}}
  {t_1 \Then e_2\st{s} \normalise t_1' \Then e_2\st{s'}}


\newrule{N-ThenFail}[\Value(t_1') = v_1 \land \lnot\Succeeding(t_2)]
  {t_1\st{s} \normalise t_1'\st{s'} \\
   e_2\ v_1 \evaluate t_2}
  {t_1 \Then e_2\st{s} \normalise t_1' \Then e_2\st{s'}}


\newrule{N-ThenCont}[\Value(t_1') = v_1 \land \Succeeding(t_2)]
  {t_1\st{s} \normalise t_1'\st{s'} \\
   e_2\ v_1 \evaluate t_2  \\
   t_2\st{s'} \normalise t_2'\st{s''}}
  {t_1 \Then e_2\st{s} \normalise t_2'\st{s''}}


%%%%

\newrule{N-Interact}
  { }
  {u\st{s} \normalise u\st{s}}

% \newrule{N-Change}
%   { }
%   {\Change l\st{s} \normalise \Change l\st{s}}

% \newrule{N-Next}[t_1' = \Edit v]
%   {t_1\st{s} \normalise t_1'\st{s'}   \\
%    e\ v \evaluate t_2       \\
%    t_2\st{s'} \normalise t_2'\st{s''} }
%   {t_1 \Next e\st{s} \normalise t_2'\st{s''}}

\newrule{N-All}[t_1' = \Edit v_1 \land t_2' = \Edit v_2]
  {t_1\st{s}  \normalise t_1'\st{s'}  \\
   t_2\st{s'} \normalise t_2'\st{s''} }
  {t_1 \And t_2\st{s} \normalise \Edit \{v_1, v_2\}\st{s}}

\newrule{N-NextEval}
  {e_1\st{s} \normalise u_1\st{s'}}
  {e_1 \Next e_2\st{s} \normalise u_1 \Next e_2\st{s'}}

\newrule{N-AndEval}
  {e_1\st{s}  \normalise u_1\st{s'}  \\
   e_2\st{s'} \normalise u_2\st{s''} }
  {e_1 \And e_2\st{s} \normalise u_1 \And u_2\st{s}}

% \newrule{N-OrEval}[t_1' \neq \Edit v_1 \land t_2' \neq \Edit v_2]
%   {t_1\st{s}  \normalise t_1'\st{s'}  \\
%    t_2\st{s'} \normalise t_2'\st{s''} }
%   {t_1 \Xor t_2\st{s} \normalise t_1' \Xor t_2'\st{s}}



%% Handling %%


\newmacro{RelationH}
  {t\st{s} \handle{h} t'\st{s'}}


\newrule{H-Change}[v, v' : \beta]
  { }
  {\Edit v\st{s} \handle{v'} \Edit v'\st{s}}


\newrule{H-Clear}[v : \beta]
  { }
  {\Edit v\st{s} \handle{\Clear} \Fill \beta\st{s}}


\newrule{H-Fill}[v' : \beta]
  { }
  {\Fill \beta\st{s} \handle{v'} \Edit v'\st{s}}


\newrule{H-Fail}
  { }
  {\Fail\st{s} \handle{h} \Fail\st{s}}


%%%%


\newrule{H-Store}[\Sigma(l), v' : \tau]
  { }
{\Change l, s \handle{v'} \Change l, [l \mapsto v']s}

\newrule{H-Stay'}[\Value(t_1) = \bot]
  {\ }
  {t_1 \Next e\st{s} \handle{\Next} t_1 \Next e\st{s}}

\newrule{H-Next'}[\Value(t_1) = v]
  {e\ v \evaluate t_2    \\
   t_2\st{s} \normalise t_2'\st{s'} }
  {t_1 \Next e\st{s} \handle{\Next} t_2'\st{s'}}

\newrule{H-Stay}[\Value(t_1) = \bot]
  {\ }
  {t_1 \Then e\st{s} \handle{\Execute \pi} t_1 \Then e\st{s}}

\newrule{H-Fail'}[\Value(t_1) = v \land t_2 = \Fail]
  {e\ v \evaluate t_2    \\
   t_2\st{s} \handle{\Pick \pi} t_2'\st{s'} }
  {t_1 \Then e\st{s} \handle{\Execute \pi} t_1 \Then e\st{s}}

\newrule{H-Next}[\Value(t_1) = v \land t_2 \neq \Fail]
  {e\ v \evaluate t_2    \\
   t_2\st{s} \handle{\Pick \pi} t_2'\st{s'} }
  {t_1 \Then e\st{s} \handle{\Execute \pi} t_2'\st{s'}}

\newrule{H-PassS}
  {t_1\st{s} \handle{h} t_1'\st{s'}}
  {t_1 \Next e\st{s} \handle{h} t_1' \Next e\st{s'}}

\newrule{H-Pass}[h \neq \Execute \pi]
  {t_1\st{s} \handle{h} t_1'\st{s'}       \\
   t_1' \Then e\st{s'} \normalise t_2\st{s''} }
  {t_1 \Then e\st{s} \handle{h} t_2\st{s''}}

\newrule{H-First}[t_1 \neq \Fail]
  {\ }
  {t_1 \Xor t_2\st{s} \handle{\Pick \First} t_1\st{s}}

\newrule{H-Second}[t_2 \neq \Fail]
  {\ }
  {t_1 \Xor t_2\st{s} \handle{\Pick \Second} t_2\st{s}}

\newrule{H-Other}[t_2 \neq \Fail]
  {t_2\st{s} \handle{\Pick \pi} t_2'\st{s'}}
  {t_1 \Xor t_2\st{s} \handle{\Pick \Other \pi} t_2'\st{s'}}

\newrule{H-Left}
  {t_1\st{s} \handle{h} t_1'\st{s'} }
  {t_1 \AndOr t_2\st{s} \handle{\Left h} t_1' \AndOr t_2\st{s'}}

\newrule{H-Right}
  {t_2\st{s} \handle{h} t_2'\st{s'} }
  {t_1\st{s} \AndOr t_2 \handle{\Right h} t_1 \AndOr t_2'\st{s'}}

\newrule{H-Fallback}
  { }
  {t\st{s} \handle{h} t\st{s}}
