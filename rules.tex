% !TEX root=report.tex


%% Helpers %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newmacro{newrule}[4][2]
  {\newmacro{#1}{\inferrule*[lab={#1},right={$#2$}]
    {#3}
    {#4}}}
\newmacro{userule}
  {\usemacro}
\newmacro{refrule}[1]
  {\ifthenelse{\isundefined{#1}}
    {\GenericError{}{Rule `#1` is not defined}{}{}}
    {\textsc{#1}}}


\newif\ifstateful
\statefulfalse
\newmacro{st}[2][1]
  {\ifthenelse{\isempty{#1}}
    {\ifstateful{,\:\mu#2}\else{}\fi}
    {\ifstateful{,\:[#1]\mu#2}\else{}\fi}}
\newmacro{St}[1]
  {\ifstateful{,\:\Sigma#1}\else{}\fi}



%% Typing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationT}
  {\Gamma\St{} \infers e : \tau}


\newrule{T-Edit}
  {\Gamma\St{} \infers e : \beta}
  {\Gamma\St{} \infers \Edit e : \Task \beta}

\newrule{T-Fill}
  {\ }
  {\Gamma\St{} \infers \Enter \beta : \Task \beta}

\newrule{T-Store}
  {\Gamma\St{} \infers e : \Reference \beta}
  {\Gamma\St{} \infers \Store e : \Task \beta}


\newrule{T-Fail}
  { }
  {\Gamma\St{} \infers \Fail : \Task \alpha}


\newrule{T-Then}
  {\Gamma\St{} \infers e_1 : \Task \tau_1 \\
   \Gamma\St{} \infers e_2 : \tau_1 \to \Task \tau_2}
  {\Gamma\St{} \infers e_1 \Then e_2 : \Task \tau_2}


\newrule{T-Next}
  {\Gamma\St{} \infers e_1 : \Task \tau_1 \\
   \Gamma\St{} \infers e_2 : \tau_1 \to \Task \tau_2}
  {\Gamma\St{} \infers e_1 \Next e_2 : \Task \tau_2}


\newrule{T-And}
  {\Gamma\St{} \infers e_1 : \Task \tau_1 \\
   \Gamma\St{} \infers e_2 : \Task \tau_2}
  {\Gamma\St{} \infers e_1 \And e_2 : \Task\,(\tau_1 \times \tau_2)}


\newrule{T-Or}
  {\Gamma\St{} \infers e_1 : \Task \tau \\
   \Gamma\St{} \infers e_2 : \Task \tau }
  {\Gamma\St{} \infers e_1 \Or e_2 : \Task \tau}


\newrule{T-Xor}
  {\Gamma\St{} \infers e_1 : \Task \tau \\
   \Gamma\St{} \infers e_2 : \Task \tau }
  {\Gamma\St{} \infers e_1 \Xor e_2 : \Task \tau}



%% Evaluation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationV}
  {e \evaluate v}


\newrule{E-Edit}
  {e \evaluate v}
  {\Edit e \evaluate \Edit v}

\newrule{E-Fill}
  {\ }
  {\Enter \beta \evaluate \Enter \beta}

\newrule{E-Store}
  {e \evaluate l}
  {\Store e \evaluate \Store l}


\newrule{E-Fail}
  { }
  {\Fail \evaluate \Fail}


\newrule{E-Then}
  {e_1 \evaluate t_1}
  {e_1 \Then e_2 \evaluate t_1 \Then e_2}

\newrule{E-Next}
  {e_1 \evaluate t_1}
  {e_1 \Next e_2 \evaluate t_1 \Next e_2}


\newrule{E-And}
  {e_1 \evaluate t_1 \\
   e_2 \evaluate t_2}
  {e_1 \And e_2 \evaluate t_1 \And t_2}


\newrule{E-Or}
  {e_1 \evaluate t_1 \\
   e_2 \evaluate t_2}
  {e_1 \Or e_2 \evaluate t_1 \Or t_2}

\newrule{E-Xor}
  {\ }
  {e_1 \Xor e_2 \evaluate e_1 \Xor e_2}





%% Normalisation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationN}
  {t\st{} \normalise t'\st{'}}


\newrule{N-Edit}
  { }
  {\Edit v\st{} \normalise \Edit v\st{}}

\newrule{N-Fill}
  { }
  {\Enter \beta\st{} \normalise \Enter \beta\st{}}

\newrule{N-Store}
  { }
  {\Store l\st{} \normalise \Store l\st{}}


\newrule{N-Fail}
  { }
  {\Fail\st{} \normalise \Fail\st{}}


\newrule{N-ThenStay}[\Value(t_1') = \bot]
  {t_1\st{} \normalise t_1'\st{'}}
  {t_1 \Then e_2\st{} \normalise t_1' \Then e_2\st{'}}

\newrule{N-ThenFail}[\Value(t_1') = v_1 \land \lnot\Succeeding(t_2)]
  {t_1\st{} \normalise t_1'\st{'} \\
   e_2\ v_1 \evaluate t_2}
  {t_1 \Then e_2\st{} \normalise t_1' \Then e_2\st{'}}

\newrule{N-ThenCont}[\Value(t_1') = v_1 \land \Succeeding(t_2)]
  {t_1\st{} \normalise t_1'\st{'} \\
   e_2\ v_1 \evaluate t_2  \\
   t_2\st{'} \normalise t_2'\st{''}}
  {t_1 \Then e_2\st{} \normalise t_2'\st{''}}

\newrule{N-Next}
  {t_1\st{} \normalise t_1'\st{'}}
  {t_1 \Next e_2\st{} \normalise t_1' \Next e_2\st{'}}


\newrule{N-And}
  {t_1\st{}  \normalise t_1'\st{'} \\
   t_2\st{'} \normalise t_2'\st{''}}
  {t_1 \And t_2\st{} \normalise t_1' \And t_2'\st{''}}


\newrule{N-OrLeft}[\Value(t_1') = v_1]
  {t_1\st{}  \normalise t_1'\st{'}}
  {t_1 \Or t_2\st{} \normalise t_1'\st{'}}

\newrule{N-OrRight}[\Value(t_1') = \bot \land \Value(t_2') = v_2]
  {t_1\st{}  \normalise t_1'\st{'} \\
   t_2\st{'} \normalise t_2'\st{''}}
  {t_1 \Or t_2\st{} \normalise t_2'\st{''}}

\newrule{N-OrNone}[\Value(t_1') = \bot \land \Value(t_2') = \bot]
  {t_1\st{}  \normalise t_1'\st{'} \\
   t_2\st{'} \normalise t_2'\st{''}}
  {t_1 \Or t_2\st{} \normalise t_1' \Or t_2'\st{''}}


\newrule{N-Xor}
  { }
  {e_1 \Xor e_2\st{} \normalise e_1 \Xor e_2\st{}}


% \newrule{N-Next}[t_1' = \Edit v]
%   {t_1\st{} \normalise t_1'\st{'}   \\
%    e\ v \evaluate t_2       \\
%    t_2\st{'} \normalise t_2'\st{''} }
%   {t_1 \Next e\st{} \normalise t_2'\st{''}}

% \newrule{N-NextEval}
%   {e_1\st{} \normalise u_1\st{'}}
%   {e_1 \Next e_2\st{} \normalise u_1 \Next e_2\st{'}}



%% Handling %%


\newmacro{RelationH}
  {t\st{} \handle{i} t'\st{'}}


\newrule{H-Change}[v, v' : \beta]
  { }
  {\Edit v\st{} \handle{v'} \Edit v'\st{}}

\newrule{H-Clear}[v : \beta]
  { }
  {\Edit v\st{} \handle{\Clear} \Enter \beta\st{}}

\newrule{H-Fill}[v' : \beta]
  { }
  {\Enter \beta\st{} \handle{v'} \Edit v'\st{}}

\newrule{H-Store}[\Sigma(l), v' : \beta]
  { }
  {\Store l\st{} \handle{v'} \Store l\st[l \mapsto v']{}}


\newrule{H-Fail}
  { }
  {\Fail\st{} \handle{i} \Fail\st{}}


\newrule{H-PassThen}
  {t_1\st{} \handle{i} t_1'\st{'}}
  {t_1 \Then e_2\st{} \handle{i} t_1' \Then e_2\st{'}}

\newrule{H-PassNext}
  {t_1\st{} \handle{i} t_1'\st{'}}
  {t_1 \Next e_2\st{} \handle{i \neq \Continue} t_1' \Next e_2\st{'}}

\newrule{H-Next}
  { }
  {t_1 \Next e_2\st{} \handle{\Continue} t_1 \Then e_2\st{}}


\newrule{H-FirstAnd}
  {t_1\st{} \handle{i} t_1'\st{'} }
  {t_1 \And t_2\st{} \handle{\First i} t_1' \And t_2\st{'}}

\newrule{H-SecondAnd}
  {t_2\st{} \handle{i} t_2'\st{'} }
  {t_1\st{} \And t_2 \handle{\Second i} t_1 \And t_2'\st{'}}


\newrule{H-FirstOr}
  {t_1\st{} \handle{i} t_1'\st{'} }
  {t_1 \Or t_2\st{} \handle{\First i} t_1' \Or t_2\st{'}}

\newrule{H-SecondOr}
  {t_2\st{} \handle{i} t_2'\st{'} }
  {t_1\st{} \Or t_2 \handle{\Second i} t_1 \Or t_2'\st{'}}


\newrule{H-PickLeft}[\Succeeding(t_1)]
  {t_1\st{} \handle{\Pick r} t_1'\st{'}}
  {t_1 \Xor t_2\st{} \handle{\Pick \Left r} t_1'\st{'}}

\newrule{H-PickRight}[\Succeeding(t_2)]
  {t_2\st{} \handle{\Pick r} t_2'\st{'}}
  {t_1 \Xor t_2\st{} \handle{\Pick \Right r} t_2'\st{'}}

\newrule{H-PickHere}
  {\ }
  {t\st{} \handle{\Pick \Here} t\st{}}



%%%%


% \newrule{H-Stay'}[\Value(t_1) = \bot]
%   {\ }
%   {t_1 \Next e\st{} \handle{\Next} t_1 \Next e\st{}}

% \newrule{H-Next'}[\Value(t_1) = v]
%   {e\ v \evaluate t_2    \\
%    t_2\st{} \normalise t_2'\st{'} }
%   {t_1 \Next e\st{} \handle{\Next} t_2'\st{'}}

% \newrule{H-Stay}[\Value(t_1) = \bot]
%   {\ }
%   {t_1 \Then e\st{} \handle{\Execute \pi} t_1 \Then e\st{}}

% \newrule{H-Fail'}[\Value(t_1) = v \land t_2 = \Fail]
%   {e\ v \evaluate t_2    \\
%    t_2\st{} \handle{\Pick \pi} t_2'\st{'} }
%   {t_1 \Then e\st{} \handle{\Execute \pi} t_1 \Then e\st{}}

% \newrule{H-Next}[\Value(t_1) = v \land t_2 \neq \Fail]
%   {e\ v \evaluate t_2    \\
%    t_2\st{} \handle{\Pick \pi} t_2'\st{'} }
%   {t_1 \Then e\st{} \handle{\Execute \pi} t_2'\st{'}}

% \newrule{H-PassS}
%   {t_1\st{} \handle{i} t_1'\st{'}}
%   {t_1 \Next e\st{} \handle{i} t_1' \Next e\st{'}}

% \newrule{H-Pass}[i \neq \Execute \pi]
%   {t_1\st{} \handle{i} t_1'\st{'}       \\
%    t_1' \Then e\st{'} \normalise t_2\st{''} }
%   {t_1 \Then e\st{} \handle{i} t_2\st{''}}

\newrule{H-Fallback}
  { }
  {t\st{} \handle{i} t\st{}}



%% Driving %%


\newmacro{RelationD}
  {t\st{} \drive{i} t'\st{'}}


\newrule{D-Main}
  {t\st{}   \handle{i} t'\st{'} \\
   t'\st{'} \normalise t''\st{''}}
  {t\st{} \drive{i} t''\st{''}}
