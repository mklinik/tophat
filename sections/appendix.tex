% !TEX root=../pldi2019.tex

\appendix
\section{Appendix}

  \subsection{Proofs}

  \subsubsection{Theorem~\ref{thmpreseval}}
\begin{proof}
  We prove Theorem~\ref{thmpreseval} by induction on $e$:\\

  \noindent\textbf{Case} $e=\lambda x:\tau.e, e_1 e_2, x, c, l, e_1 \star e_2,
      \If{e_1}{e_2}{e_3},$\\
      $\tuple{e_1, e_2},\unit,\Ref e,!e,e_1 := e_2,e_1; e_2$ preservation has
      been proven for these cases by \todo{insert cite}\\

  \noindent\textbf{Case} $\userule{E-Edit}$
      Given that $\Gamma,\Sigma\infers\Edit e:\Task \tau$ and $\Gamma,\Sigma\infers s$, T-Edit gives us that
      $\Gamma,\Sigma\infers e:\tau$. The induction hypothesis gives us that
      $e,s\evaluate v,s'$ also preserves, and thus $\Gamma,\Sigma\infers v:\tau$
      and $\Gamma,\Sigma\infers s'$. Therefore $\Gamma,\Sigma\infers\Edit v:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{E-Fill}$
      Evaluation does not alter $e$ and $s$, therefore this case holds tivially.\\

  \noindent\textbf{Case} $\userule{E-Update}$
      Given that $\Gamma,\Sigma\infers \Edit e:\Task \tau$ and
      $\Gamma,\Sigma\infers s$, T-Update gives us that $\Gamma,\Sigma\infers e:\Ref \tau$.
      The induction hypothesis gives us that $e,s\evaluate l,s'$ also preserves,
      and thus $\Gamma,\Sigma\infers l:\Ref\tau$ and $\Gamma,\Sigma\infers s'$.
      Therefore $\Gamma,\Sigma\infers\Update l:\Task\tau$\\

  \noindent\textbf{Case} $\userule{E-Fail}$
      Evaluation does not alter $e$ and $s$, therefore this case holds tivially.\\

  \noindent\textbf{Case} $\userule{E-Then}$
      Given that $\Gamma,\Sigma\infers e_1\Then e_2:\Task \tau$ and $\Gamma,\Sigma\infers s$, T-Then gives us that $\Gamma,\Sigma\infers e_1:\Task\tau_1$
      and $\Gamma,\Sigma\infers e_2:\tau_1 \to \Task \tau$. By the induction hypothesis, we know that
      $e_1,s\evaluate t_1,s'$ preserves and thus $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers s'$. Therefore
      $\Gamma,\Sigma\infers t_1\Then e_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{E-Next}$
      Given that $\Gamma,\Sigma\infers e_1\Next e_2:\Task \tau$ and $\Gamma,\Sigma\infers s$, T-Then gives us that $\Gamma,\Sigma\infers e_1:\Task\tau_1$
      and $\Gamma,\Sigma\infers e_2:\tau_1 \to \Task \tau$. By the induction hypothesis, we know that
      $e_1,s\evaluate t_1,s'$ preserves and thus $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers s'$. Therefore
      $\Gamma,\Sigma\infers t_1\Next e_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{E-And}$
      Given that $\Gamma,\Sigma\infers e_1\And e_2:\Task(\tau_1\times\tau_2)$ and $\Gamma,\Sigma\infers s$, T-And gives us that
      $\Gamma,\Sigma\infers e_1:\Task\tau_1$ and $\Gamma,\Sigma\infers e_2:\Task\tau_2$. By the induction hypothesis, we
      know that both $e_1,s\evaluate t_1,s'$ and $e_2,s'\evaluate t_2,s''$ preserve and thus
      $\Gamma,\Sigma\infers t_1:\Task\tau_1$, $\Gamma,\Sigma\infers s'$, $\Gamma,\Sigma\infers t_2:\Task\tau_2$ and $\Gamma,\Sigma\infers s''$. Therfore
      $\Gamma,\Sigma\infers t_1\And t_2:\Task(\tau_1\times\tau_2)$\\

  \noindent\textbf{Case} $\userule{E-Or}$
      Given that $\Gamma,\Sigma\infers e_1\Or e_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, T-Or gives us that $\Gamma,\Sigma\infers e_1:\Task\tau$ and
      $\Gamma,\Sigma\infers e_2:\Task\tau$. By the induction hypothesis, we have that both
      $e_1,s\evaluate t_1,s'$ and $e_2,s'\evaluate t_2,s''$ preserve and thus $\Gamma,\Sigma\infers t_1:\Task\tau$, $\Gamma,\Sigma\infers s'$,
      $\Gamma,\Sigma\infers t_2:\Task\tau$ and $\Gamma,\Sigma\infers s''$. Therefore $\Gamma,\Sigma\infers t_1\Or t_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{E-Xor}$
      Evaluation does not alter $e$ and $s$, therefore this case holds tivially.\\

  \noindent\textbf{Case} $\userule{E-At}$
      Given that $\Gamma,\Sigma\infers u@e:\Task\tau$ and $\Gamma,\Sigma\infers s$, the induction hypothesis gives us that $e,s\evaluate t,s'$ also preserves, and therefore by T-At $\Gamma,\Sigma\infers u@t:\Task\tau$.
\end{proof}



\subsubsection{Lemma~\ref{lemmavaluepreserves}}
\begin{proof}
  We prove Lemma~\ref{lemmavaluepreserves} by induction over $e$.\\

  \noindent\textbf{Case} $\Value{(\Edit v,s)}=v$ By T-Edit, if $\Gamma,\Sigma\infers \Edit v:\Task\tau$, then $\Gamma,\Sigma\infers v:\tau$.\\

  \noindent\textbf{Case} $\Value{(\Enter \tau,s)}=\bot$ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(\Update l,s)}=s(l)$ Given that $\Gamma,\Sigma\infers\Update l:\Task \tau$ and $\Gamma,\Sigma\infers s$, we know that $\Gamma,\Sigma\infers s(l):\tau$.\\

  \noindent\textbf{Case} $\Value{(\Fail,s)}=\bot$ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(t_1\Then e_2,s)}=\bot$ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(t_2\Next e_2,s)}=\bot$ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(t_1\And t_2,s)}=\tuple{v_1, v_2}$ given that $\Value{(t_1,s)}=v_1\wedge\Value{(t_2,s)}=v_2$\\ By T-And we have that $\Gamma,\Sigma\infers t_1\And t_2:\Task(\tau_1\times\tau_2)$ and $\Gamma,\Sigma\infers t_1:\tau_1$ and $\Gamma,\Sigma\infers t_2:\tau_2$. By the induction hypothesis, $ \Value{(t_1,s)}=v_1$ and $\Value{(t_2,s)}=v_2$ preserve, and thus $\Gamma,\Sigma\infers v_1:\tau_1$ and $\Gamma,\Sigma\infers v_2:\tau_2$. This gives us that $\Gamma,\Sigma\infers \tuple{v_1, v_2}:\Task(\tau_1\times\tau_2)$ \\

  \noindent\textbf{Case} $\Value{(t_1\And t_2,s)}=\bot$ given that $\neg(\Value{(t_1,s)}=v_1\wedge\Value{(t_2,s)}=v_2)$\\ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(t_1\Or t_2,s)}=v_1$ given that $\Value{(t_1,s)}=v_1$\\ By T-Or we have that $\Gamma,\Sigma\infers t_1\Or t_2:\Task\tau$, and $\Gamma,\Sigma\infers t_1:\Task\tau$ and $\Gamma,\Sigma\infers t_2:\Task\tau$. By the induction hypothesis, we have that $\Gamma,\Sigma\infers v_1:\tau$.\\

  \noindent\textbf{Case} $\Value{(t_1\Or t_2,s)}=v_2$ given that $\Value{(t_1,s)}=\bot\wedge\Value{(t_2,s)}=v_2$\\ By T-Or we have that $\Gamma,\Sigma\infers t_1\Or t_2:\Task\tau$, and $\Gamma,\Sigma\infers t_1:\Task\tau$ and $\Gamma,\Sigma\infers t_2:\Task\tau$. By the induction hypothesis, we have that $\Gamma,\Sigma\infers v_2:\tau$.\\

  \noindent\textbf{Case} $\Value{(t_1\Or t_2,s)}=\bot$ given that $\Value{(t_1,s)}=\bot\wedge\Value{(t_2,s)}=\bot$\\ Since this case does not lead to a value, the lemma holds trivially.\\

  \noindent\textbf{Case} $\Value{(t_1\Xor t_2,s)}=\bot$ Since this case does not lead to a value, the lemma holds trivially.\\
\end{proof}



\subsubsection{Theorem~\ref{thmpresnorm}}
\begin{proof}
  We prove Theorem~\ref{thmpresnorm} by induction on $e$:\\

  \noindent\textbf{Case} $\userule{N-Fail}$ Since this case does not alter the
  expression, the theorem holds trivially.\\

  \noindent\textbf{Case} $\userule{N-Xor}$ Since this case does not alter the
  expression, the theorem holds trivially.\\

  \noindent\textbf{Case} $\userule{N-Update}$ Since this case does not alter
  the expression, the theorem holds trivially.\\

  \noindent\textbf{Case} $\userule{N-Fill}$ Since this case does not alter the
  expression, the theorem holds trivially.\\

  \noindent\textbf{Case} $\userule{N-Edit}$ Since this case does not alter the
  expression, the theorem holds trivially.\\

  \noindent\textbf{Case} $\userule{N-And}$ Given that $t_1\And t_2:\Task(\tau_1\times\tau_2)$, by T-And we have $t_1:\tau_1$ and $t_2:\tau_2$. By the induction hypothesis, we also have $t_1':\tau_1$ and $t_2':\tau_2$. This gives us that $t_1'\And t_2':\Task(\tau_1\times\tau_2)$.\\

  \noindent\textbf{Case} $\userule{N-Next}$ Given that $e_1\Next e_2:\Task \tau$, T-Then gives us that $t_1:\Task\tau_1$
  and $e_2:\tau_1 \to \Task \tau$. By the induction hypothesis, we know that
  $t_1\normalise t_1'$ preserves and thus $t_1':\Task\tau_1$. Therefore
  $t_1'\Next e_2:\Task\tau$.\\\\

  \noindent\textbf{Case} $\userule{N-OrLeft}$ Given that $t_1\Or t_2:\Task\tau$,
  by T-Or we have $t_1:\Task\tau$. By the induction hypothesis, we know that
  $t_1\normalise t_1'$ preserves and thus $t_1':\Task\tau$.\\

  \noindent\textbf{Case} $\userule{N-OrRight}$ Given that $t_1\Or t_2:\Task\tau$,
  by T-Or we have $t_2:\Task\tau$. By the induction hypothesis, we know that
  $t_2\normalise t_2'$ preserves and thus $t_2':\Task\tau$. \todo{there might be
  more to be said here. t1 obviously can to stuff too, but we don't say anyting about this.}\\

  \noindent\textbf{Case} $\userule{N-OrNone}$ Given that $t_1\Or t_2:\Task\tau$,
  by T-Or we have $t_1:\Task\tau$ and $t_2:\Task\tau$. By the induction hypothesis,
  we know that $t_1\normalise t_1'$ and $t_2\normalise t_2'$ preserve, and thus
  $t_1'\Or t_2':\Task\tau$.\\

  \noindent\textbf{Case} $\userule{N-ThenStay}$ Given that $t_1\Then e_2:\Task\tau$,
  by T-Then we have $t_1:\Task\tau_1$ and $e_2:\tau_1\to\Task\tau$. By the induction
  hypothesis, we know that $t_1\normalise t_1'$ preserves, and thus $t_1'\Then e_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{N-ThenFail}$ Given that $t_1\Then e_2:\Task\tau$,
  by T-Then we have $t_1:\Task\tau_1$ and $e_2:\tau_1\to\Task\tau$. By the induction
  hypothesis, we know that $t_1\normalise t_1'$ preserves, and thus $t_1'\Then e_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{N-ThenCont}$Given that $t_1\Then e_2:\Task\tau$,
  by T-Then we have $t_1:\Task\tau_1$ and $e_2:\tau_1\to\Task\tau$. By the induction
  hypothesis, we know that $t_1\normalise t_1'$ preserves. By
  Lemma~\ref{lemmavaluepreserves}, we know that $\Value{(t_1')}=v_1$ preserves.
  By Theorem~\ref{thmpreseval} we know that $e_2 v_1\evaluate t_2$ preserves. And
  finally by the induction hypothesis, we know that $t_2\normalise t_2'$ preserves.
  Therefore $t_2':\Task\tau$.\\

\end{proof}


\subsubsection{Theorem~\ref{thmpreshandle}}

We require the following Lemma for this proof.

\begin{lemma}
  Given that $\Gamma,\Sigma\infers s$, $\Sigma(l)=\tau$ and $\Gamma,\Sigma\infers v:\tau$, it holds that $\Gamma,\Sigma\infers s[l\mapsto v]$
  \label{lemmasigmaconsistent}
\end{lemma}
This lemma follows immediately from definition.

\begin{proof}
  We prove Theorem~\ref{thmpreshandle} by induction on $e$:

  \noindent\textbf{Case} $\userule{H-Change}$ Given that $\Gamma,\Sigma\infers\Edit v:\Task\tau$ and $\Gamma,\Sigma\infers s$, the H-Change rule additionally gives us that $v,v':\tau$. Therefore by T-Edit we have that $\Gamma,\Sigma\infers\Edit v':\Task\tau$\\

  \noindent\textbf{Case} $\userule{H-Empty}$ Given that $\Gamma,\Sigma\infers\Edit v:\Task\beta$ and $\Gamma,\Sigma\infers s$, the H-Empty rule additionally gives us that $v:\tau$. Then by T-Fill we have $\Gamma,\Sigma\infers\Enter \tau:\Task\tau$ \\

  \noindent\textbf{Case} $\userule{H-Fill}$ Given that $\Gamma,\Sigma\infers\Enter\tau$ and $\Gamma,\Sigma\infers s$, the H-Fill rule additionally gives us that $v':\tau$. Then by T-Fill we have $\Gamma,\Sigma\infers \Edit v':\Task\tau$.\\

  \noindent\textbf{Case} $\userule{H-Update}$ Given that $\Gamma,\Sigma\infers\Update l:\Task\tau$ and $\Gamma,\Sigma\infers s$. This gives us that $\Sigma(l)=\tau$, and we additionally obtain $s(l),v':\tau$ by H-Update. By application of Lemma~\ref{lemmasigmaconsistent} this case holds.\\

  \noindent\textbf{Case} $\userule{H-PickLeft}$ Given that $\Gamma,\Sigma\infers t_1\Xor t_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, then by T-Xor we have $\Gamma,\Sigma\infers t_1:\Task \tau$.\\

  \noindent\textbf{Case} $\userule{H-PickRight}$ Given that $\Gamma,\Sigma\infers t_1\Xor t_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, then by T-Xor we have $\Gamma,\Sigma\infers t_2:\Task \tau$. \\

  \noindent\textbf{Case} $\userule{H-Next}$ Given that $\Gamma,\Sigma\infers t_1\Next e_2 :\Task\tau$ and $\Gamma,\Sigma\infers s$. Then by T-Next, we have $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers e_2:\tau_1\to\Task\tau$. Then by T-Then we obtain $\Gamma,\Sigma\infers t_1\Then e_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{H-PassThen}$ Given that $\Gamma,\Sigma\infers t_1\Then e_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, T-Then gives us that $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers e_2:\tau_1\to\Task\tau$. By the induction hypothesis, we know that $t_1,s\handle{i}t_1',s'$ also preserves and thus $\Gamma,\Sigma\infers t_1':\Task\tau_1$ and $\Gamma,Sigma\infers s'$. By T-Then we now obtain that $\Gamma,\Sigma\infers t_1'\Then e_2:\Task\tau$. \\

  \noindent\textbf{Case} $\userule{H-PassNext}$ Given that $\Gamma,\Sigma\infers t_1\Next e_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, T-Next gives us that $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers e_2:\tau_1\to\Task\tau$. By the induction hypothesis, we know that $t_1,s\handle{i}t_1',s'$ also preserves and thus $\Gamma,\Sigma\infers t_1':\Task\tau_1$ and $\Gamma,Sigma\infers s'$. By T-Next we now obtain that $\Gamma,\Sigma\infers t_1'\Next e_2:\Task\tau$. \\

  \noindent\textbf{Case} $\userule{H-FirstAnd}$ Given that $\Gamma,\Sigma\infers t_1\And t_2:\Task(\tau_1\times\tau_2)$ and $\Gamma,\Sigma\infers s$, T-And gives us that $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers t_2:\Task\tau_2$. By the induction hypothesis, we know that $t_1,s\handle{i}t_1',s'$ also preserves and thus $\Gamma,\Sigma\infers t_1':\Task\tau_1$ and $\Gamma,\Sigma\infers s'$. Therefore by T-Next we obtain $\Gamma,\Sigma\infers t_1'\And t_2:\Task(\tau_1\times\tau_2)$.\\

  \noindent\textbf{Case} $\userule{H-SecondAnd}$ Given that $\Gamma,\Sigma\infers t_1\And t_2:\Task(\tau_1\times\tau_2)$ and $\Gamma,\Sigma\infers s$, T-And gives us that $\Gamma,\Sigma\infers t_1:\Task\tau_1$ and $\Gamma,\Sigma\infers t_2:\Task\tau_2$. By the induction hypothesis, we know that $t_2,s\handle{i}t_2',s'$ also preserves and thus $\Gamma,\Sigma\infers t_2':\Task\tau_2$ and $\Gamma,\Sigma\infers s'$. Therefore by T-Next we obtain $\Gamma,\Sigma\infers t_1\And t_2':\Task(\tau_1\times\tau_2)$.\\

  \noindent\textbf{Case} $\userule{H-FirstOr}$ Given that $\Gamma,\Sigma\infers t_1\Or t_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, T-Or gives us that $\Gamma,\Sigma\infers t_1:\Task\tau$ and $\Gamma,\Sigma\infers t_2:\Task\tau$. By the induction hypothesis we know that $t_1,s\handle{i}t_1',s'$ also preserves, and therefore $\Gamma,\Sigma\infers t_1':\Task\tau$ and $\Gamma,\Sigma\infers s'$. By T-Or we now obtain $\Gamma,\Sigma\infers t_1'\Or t_2:\Task\tau$.\\

  \noindent\textbf{Case} $\userule{H-SecondOr}$ Given that $\Gamma,\Sigma\infers t_1\Or t_2:\Task\tau$ and $\Gamma,\Sigma\infers s$, T-Or gives us that $\Gamma,\Sigma\infers t_1:\Task\tau$ and $\Gamma,\Sigma\infers t_2:\Task\tau$. By the induction hypothesis we know that $t_2,s\handle{i}t_2',s'$ also preserves, and therefore $\Gamma,\Sigma\infers t_2':\Task\tau$ and $\Gamma,\Sigma\infers s'$. By T-Or we now obtain $\Gamma,\Sigma\infers t_1\Or t_2':\Task\tau$.
\end{proof}

% \subsubsection{Theorem~\ref{thmprogressnorm}}
%
% \begin{proof} We prove this Theorem by induction on $e$.\\
%
%   \noindent\textbf{Case} $\userule{N-Edit}$ Given that $\Gamma,\Sigma\infers \Edit v : \Task \tau$, let $e''=\Edit v'$, $s''=s$ and $i=v':\tau$. Then H-Edit gives $\Edit v,s\handle{v'}\Edit v',s$. \\
%
%
%   \noindent\textbf{Case} $\userule{N-Fill}$ Given that $\Gamma,\Sigma\infers \Enter \tau : \Task \tau$, let $e''=\Edit v$, $s''=s$ and $i=v:\tau$. Then H-Fill gives $\Enter \tau,s\handle{v}\Edit v,s$. \\
%
%   \noindent\textbf{Case} $\userule{N-Update}$ Given that $\Gamma,\Sigma\infers \Update l : \Task \tau$, let $e''=\Update l$, $s''=s[l\mapsto v]$ and $i=v:\tau$. Then H-Update gives $\Update l ,s\handle{v}\Update l,s[l\mapsto v]$. \\
%
%   \noindent\textbf{Case} $\userule{N-Fail}$ Since $\Failing(\Fail)=\True$, the theorem holds in this case. \\
%
%   \noindent\textbf{Case} $\userule{N-Xor}$ \todo{Here we have an issue with the defintion of $\Failing$ and the sideconditions of external choice. These definitions should concur, so we can finish the proof, but $\Failing$ is a static property}\\
%
%   \noindent\textbf{Case} $\userule{N-Eval}$ By induction hypothesis we have that there exists an $e'''$, $s'''$ and $i$ such that $e'',s''\handle{i}e''',s'''$.\\
%
%   \noindent\textbf{Case} $\userule{N-ThenStay}$ By the induction hyposthesis we have that there exists an $e''$, $s''$ and $i$ such that $t_1',s'\handle{i}e'',s''$. Then by H-Pass, we know that we can apply the same $i$ to obtain $t_1\Then e_2,s'\handle{i} e''\Then e,s''$.\\
%
%   \noindent\textbf{Case} $\userule{N-ThenFail}$ By the induction hyposthesis we have that there exists an $e''$, $s''$ and $i$ such that $t_1',s'\handle{i}e'',s''$. Then by H-Pass, we know that we can apply the same $i$ to obtain $t_1\Then e_2,s'\handle{i} e''\Then e,s''$.\\
%
%   \noindent\textbf{Case} $\userule{N-ThenCont}$ By the induction hypothesis, we have that there exists an $e''$, $s''''$ and $i$ such that $t_2',s''\handle{i}e'',s''''$.\\
%
%   \noindent\textbf{Case} $\userule{N-OrLeft}$ By the induction hypothesis, we have that there exists an $e''$, $s'$ and $i$ such that $t_1',s\handle{i}e'',s''$.\\
%
%   \noindent\textbf{Case} $\userule{N-OrRight}$ By the induction hypothesis, we have that there exists an $e''$, $s'$ and $i$ such that $t_2',s\handle{i}e'',s''$.\\
%
%   \noindent\textbf{Case} $\userule{N-OrNone}$ \todo{   }\\
%
%   \noindent\textbf{Case} $\userule{N-Next}$ By the induction hypothesis, we have that there exists an $e''$, $s'$ and $i$ such that $t_1',s'\handle{i}e'',s''$. Then by the H-PassNext rule, we know that we can apply the same $i$ to obtain $t_1'\Next e_2,s'\handle{i}e'',s''$.\\
%
%   \noindent\textbf{Case} $\userule{N-And}$ By the induction hypothesis, we have that there exists an $e''$, $s'$ and $i$ such that $t_1',s'\handle{i}e'',s''$. Then by the H-FirstOr rule, we know that we can apply $\First i$ to obtain $t_1'\And t_2',s'\handle{\First i} t_1''\And t_2',s''$
%
% \end{proof}


\subsubsection{Theorem~\ref{thmnormisbigstep}}

\begin{proof}
  We prove Theorem~\ref{thmpresnorm} by induction on $e$:\\

  \noindent\textbf{Case} $\userule{N-Stable}$\\

  \noindent\textbf{Case} $\userule{N-Memory}$\\

  \noindent\textbf{Case} $\userule{N-Fail}$ \\

  \noindent\textbf{Case} $\userule{N-Xor}$ \\

  \noindent\textbf{Case} $\userule{N-Update}$ \\

  \noindent\textbf{Case} $\userule{N-Fill}$ \\

  \noindent\textbf{Case} $\userule{N-Edit}$ \\

  \noindent\textbf{Case} $\userule{N-And}$ \\

  \noindent\textbf{Case} $\userule{N-Next}$ \\

  \noindent\textbf{Case} $\userule{N-OrLeft}$ \\

  \noindent\textbf{Case} $\userule{N-OrRight}$ \\

  \noindent\textbf{Case} $\userule{N-OrNone}$\\

  \noindent\textbf{Case} $\userule{N-ThenStay}$\\

  \noindent\textbf{Case} $\userule{N-ThenFail}$\\

  \noindent\textbf{Case} $\userule{N-ThenCont}$\\

  \noindent\textbf{Case} $\userule{N-Assign}$

\end{proof}

\subsubsection{Theorem~\ref{thmfailing}}

We prove Theorem~\ref{thmfailing} by induction on $e'$.

\begin{proof}

  \noindent\textbf{Case} $e = \Fail$ \\

  \noindent\textbf{Case} $e = \Edit v$ \\

  \noindent\textbf{Case} $e = \Enter \tau$\\

  \noindent\textbf{Case} $e = \Update l$\\

  \noindent\textbf{Case} $e = t_1\Then e_2$\\

  \noindent\textbf{Case} $e = t_1\Next e_2$\\

  \noindent\textbf{Case} $e = e_1\Xor e_2$\\

  \noindent\textbf{Case} $e = t_1\And t_2$\\

  \noindent\textbf{Case} $e = t_1\Or t_2$\\

  \noindent\textbf{Case} $e = u@t$\\
\end{proof}

\subsubsection{Theorem~\ref{thmsafetyi1}}

\begin{proof}
  \noindent\textbf{Case} $\Edit v:\Task\tau$ By definition, $\Inputs{(\Edit v)}=\{v',\Empty\}$. For $i=v'$, we have that $\userule{H-Change}$ handles the input, and for $i=\Empty$, we have $\userule{H-Empty}$.\\

  \noindent\textbf{Case} $\Enter \tau$ By definition, $\Inputs{(\Enter \tau)}=\{v':\tau\}$. For $i=v'$, we have that $\userule{H-Fill}$ handles the input.\\

  \noindent\textbf{Case} $\Update l:\Task\tau$ By definition, $\Inputs{(\Update\tau)}=\{v'\}$. For $i=v'$, we have that $\userule{H-Update}$ handles the input.\\

  \noindent\textbf{Case} $\Fail$ By definition, $\Inputs{(\Fail)}=\{\}$. The theorem holds trivially.\\

  \noindent\textbf{Case} $t_1\Then e_2$ By definition, $\Inputs{(t_1\Then e_2)}=\Inputs{(t_1)}$. By the induction hypothesis, we have that $i\in\Inputs{(t_1)}$, then $t_1\handle{i}t_1'$. Therefore, we also have $\userule{H-PassThen}$.\\

  \noindent\textbf{Case} $t_1\Next e_2$ By definiton, $\Inputs(t_1 \Next e_2) = \Inputs(t_1) \cup \set{\Continue\mid \Value{(t_1)}\neq \bot \wedge \neg\Failing{(e_2 \Value{(t_1)}\normalise)}}$. If $i=\Continue$, then we know that $\Value{(t_1)}\neq \bot \wedge \neg\Failing{(e_2 \Value{(t_1)}\normalise)}$ holds, and therefore H-Next applies. Otherwise, we have by induction hypothesis that $i\in\Inputs{(t_1)}$, then $t_1\handle{i}t_1'$. Therefore, we also have $\userule{H-PassNext}$.\\

  \noindent\textbf{Case} $t_1\And t_2$ By definiiton, $\Inputs(t_1\And t_2) = \set{\First\ i \mid i \in \Inputs(t_1)} \cup \set{\Second\ i \mid i \in \Inputs(t_2)}$. By the induction hypothesis, we have both that if $i\in\Inputs(t_1)$ then $t_1\handle{i}t_1'$ and that if $i\in\Inputs(t_2)$ then $t_2\handle{i}t_2'$. Therefore, if $i\in\Inputs(t_1\And t_2)$, then either $\userule{H-FirstAnd}$ or $\userule{H-SecondAnd}$.\\

  \noindent\textbf{Case} $t_1\Or t_2$ By definition, $\Inputs(t_1\Or t_2) = \set{\First\ i \mid i \in \Inputs(t_1)} \cup \set{\Second\ i \mid i \in \Inputs(t_2)}$. By the induction hypothesis, we have both that if $i\in\Inputs(t_1)$ then $t_1\handle{i}t_1'$ and that if $i\in\Inputs(t_2)$ then $t_2\handle{i}t_2'$. Therefore, if $i\in\Inputs(t_1\Or t_2)$, then either $\userule{H-FirstOr}$ or $\userule{H-SecondOr}$.\\

  \noindent\textbf{Case} $t_1\Xor t_2$ By definition, $\Inputs(t_1\Xor t_2) = \set{\Pick \Left, \Pick \Right}$. In case $i=\Pick\Left$, H-PickLeft applies, in case $i=\Pick\Right$, H-PickRight applies.

\end{proof}

\subsubsection{Theorem~\ref{thmsafetyi2}}
\begin{proof}
  \noindent\textbf{Case} $e=\Edit v:\Task\tau, i= v':\tau$\\
  \noindent\textbf{Case} $e=\Edit v:\Task\tau, i= \Empty$\\
  \noindent\textbf{Case} $e=\Enter \tau, i= v':\tau$\\
  \noindent\textbf{Case} $e=\Update l:\Task\tau, i= v':\tau$\\
  \noindent\textbf{Case} $e=t_1\Or t_2 , i= \Pick\Left r $\\
  \noindent\textbf{Case} $e=t_1\Or t_2 , i= \Pick\Right r $\\
  \noindent\textbf{Case} $e=t, i= \Pick\Here $\\
  \noindent\textbf{Case} $e=t_1\Next e_2 , i= \Continue $\\
  \noindent\textbf{Case} $e=t_1\Then e_2 , i$\\
  \noindent\textbf{Case} $e=t_1\Next e_2 , i\neq\Continue$\\
  \noindent\textbf{Case} $e=t_1\And t_2 , i=\First i$\\
  \noindent\textbf{Case} $e=t_1\And t_2 , i=\Second i$\\
  \noindent\textbf{Case} $e=t_1\Or t_2 , i=\First i$\\
  \noindent\textbf{Case} $e=t_1\Or t_2 , i=\Second i$\\
\end{proof}
