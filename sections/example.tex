% !TEX root=../pldi2019.tex

\section{Example}

In this section we develop a small example program to demonstrate the capabilities of \TOPHAT.
The example is a simple flight booking system.
It demonstrates communication with the environment, communication between parallel tasks, synchronisation, and input validation.

The application works as follows.
\begin{itemize}
\item Multiple users should be able to book tickets at the same time.
\item A user first has to input a list of passengers for which to book tickets.
\item At least one of the passengers has to be an adult.
\item After a valid list of passengers has been input, the user has to pick a seat for each passenger.
\item Only free seats may be picked.
\item Every passenger must have exactly one seat.
\end{itemize}
For this example we assume that the host language has lists and some functions on them, like length, filter, intersect, et cetera.

We start by defining some data types.
A passenger is a tuple with name and age.
A seat is a tuple with a row number and a seat letter.
\begin{equation*}
\begin{array}{l @{} l}
  \text{type}\ \text{Passenger} =  \String \times \Int \\
  \text{type}\ \text{Seat} =  \Int \times \String \\
\end{array}
\end{equation*}
The flight booking task starts with entering a valid list of passengers.
A passenger is valid if the name is not empty and the age is at least 0.
A list of passengers is valid if each passenger is valid, and at least one of the passengers is an adult.
When the user has entered a valid list of passengers, the step becomes enabled, and the user can proceed to picking seats.
\begin{TASK}
  valid <.name, age>. = not (name == "") && age >= 0
  adult <.name, age>. = age >= 18
  allValid ps = all valid ps && any adult ps
  bookFlight = enter [Passenger] >>? \ps -> if allValid ps then chooseSeats ps else fail
\end{TASK}
Choosing seats requires reading and updating shared data.
The list of free seats is stored in a global share called \emph{freeSeats}.
A selection of seats is valid if every seat is free.
\begin{TASK}
  validSeats pickedSeats =
    intersect pickedSeats (!freeSeats) == pickedSeats
  chooseSeats ps = enter [Seat] >>? \ss ->
    if validSeats ss
      then confirmBooking ps ss else fail
  confirmBooking ps ss =
      freeSeats := difference (!freeSeats) ss;
      edit <.ps, ss>.
\end{TASK}
The function \emph{confirmBooking} removes the picked seats from the list of free seats, and displays the end result.
It uses a function \emph{difference}, which removes all elements from the second list from the first list.
\fixme{Add screenshot of running application.}
