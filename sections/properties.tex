% !TEX root=../pldi2019.tex

\section{Properties}

\subsection{Equality}

The intuitive idea of task equality is that of observational equivalence.
We consider two tasks equal if the user can do essentially the same things with them.
The notion of \emph{essentially the same things} is made precise in the following definition.

\begin{definition}
Two events are \emph{essentially the same}, written $h_1 \approx h_2$ if they are syntactically equivalent after stripping Ls and Rs. \qed
\end{definition}

\begin{definition}
(Bisimulation) A binary relation $R$ is a bisimulation relation between tasks iff the following conditions hold for all $t_1 \mathrel{R} t_2$.
\begin{itemize}
\item $\mathcal{V}(t_1) = \mathcal{V}(t_2)$
\item $\forall h_1 . \exists h_2 . h_1 \approx h_2 \wedge t_1 \implies t_1' \wedge t_2 \implies t_2' \wedge t_1' \mathrel{R} t_2'$
\item $\forall h_2 . \exists h_1 . h_1 \approx h_2 \wedge t_1 \implies t_1' \wedge t_2 \implies t_2' \wedge t_1' \mathrel{R} t_2'$ \qed
\end{itemize}
\end{definition}

\begin{definition}
(Task equality) Two tasks are equal iff there exists a bisimulation relation containing them. \qed
\end{definition}

\subsection{Safety}
\subsubsection{Preservation}


\begin{theorem}[preservation under evaluation]
      For all $e$ and $s$ such that
      $\Gamma,\Sigma\infers e:\tau$ and $\Gamma\St{}\infers s$\\
      if $e,s\evaluate e',s'$
      then $\Gamma,\Sigma\infers e':\tau$ and $\Gamma,\Sigma\infers s'$
      \label{thmpreseval}
\end{theorem}

\begin{lemma}[Task value preserves]
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Gamma,\Sigma\infers s$\\
  if $\Value{(e,s)}=v$ then $v:\tau$
  \label{lemmavaluepreserves}
\end{lemma}

\begin{theorem}[preservation under normalization]
    For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
    if   $e,s \normalise e',s'$ then $\Gamma,\Sigma\infers e':\tau$ and $\Gamma,\Sigma\infers s'$
    \label{thmpresnorm}
\end{theorem}

\begin{theorem}[preservation under handling]
  For all $e$, $s$ and $i$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $ e,s \handle{i} e's'$ then $\Gamma,\Sigma\infers e':\tau$ and $\Gamma,\Sigma\infers s'$
   \label{thmpreshandle}
\end{theorem}

\subsubsection{Progress}

\begin{theorem}[Progress of handling]
 For all $e$, $s$ and $i$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
 if $e,s \drive{i} e',s'$ then either $\Failing(e')$ or there exists an $e''$ and $i'$ such that $e',s'\handle{i'}e'',s''$
\end{theorem}

which we prove by showing that the following Theorem holds:
\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $e,s \normalise e',s'$ then either $\Failing(e')$ or there exists an $e''$, $s''$ and $i$ such that $e',s'\handle{i}e'',s''$
  \label{thmprogressnorm}
\end{theorem}

\subsubsection{Normalisation is Big-Step}

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $e,s\normalise e',s'$ and $e',s'\normalise e'',s''$, then $e'\equiv e''$ and $s'\equiv s''$.
\end{theorem}

\subsubsection{Failing means no interaction possible}

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $\Failing(e,s)\equiv \True$, then $e,s\normalise e',s'$ implies $e\equiv e'$ and $s\equiv s'$\\
  and there is no $i$ such that $e,s\handle{i}e',s'$ for some $e'$ and $s'$.
\end{theorem}


\subsubsection{Safety of Inputs function}

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $i\in\Inputs{(e)}$ then $e,s\handle{i}e',s'$
  \label{thmsafetyi1}
\end{theorem}

\begin{theorem}
  For all $e$, $s$ and $i$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Gamma,\Sigma\infers s$\\
  if $e,s\handle{i}e',s'$ then  $i\in\Inputs{(e)}$
  \label{thmsafetyi2}
\end{theorem}
\subsection{Laws}
