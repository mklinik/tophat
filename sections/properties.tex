% !TEX root=../pldi2019.tex

\section{Properties}

\subsection{Equality}

The intuitive idea of task equality is that of observational equivalence.
We consider two tasks equal if the user can do essentially the same things with them.
The notion of \emph{essentially the same things} is made precise in the following definition.

\begin{definition}
Two events are \emph{essentially the same}, written $h_1 \approx h_2$ if they are syntactically equivalent after stripping Ls and Rs. \qed
\end{definition}

\begin{definition}
(Bisimulation) A binary relation $R$ is a bisimulation relation between tasks iff the following conditions hold for all $t_1 \mathrel{R} t_2$.
\begin{itemize}
\item $\mathcal{V}(t_1) = \mathcal{V}(t_2)$
\item $\forall h_1 . \exists h_2 . h_1 \approx h_2 \wedge t_1 \implies t_1' \wedge t_2 \implies t_2' \wedge t_1' \mathrel{R} t_2'$
\item $\forall h_2 . \exists h_1 . h_1 \approx h_2 \wedge t_1 \implies t_1' \wedge t_2 \implies t_2' \wedge t_1' \mathrel{R} t_2'$ \qed
\end{itemize}
\end{definition}

\begin{definition}
(Task equality) Two tasks are equal iff there exists a bisimulation relation containing them. \qed
\end{definition}

\subsection{Safety}

In order to validate our semantics, we show that our evaluation, normalisation
and handling semantics is type preserving. We additionally prove a progress
theorem for our small-step handling semantics.

Additionally, we show that the normalisation semantics is a big-step semantics.
While at first sight, this might seem obvious, the fact that we are dealing with
state complicates matters.

We show that our failing function $\Failing$ indeed only indicates expressions
that can not be normalised and that allow no further interaction.

Finally we prove that the function to compute all possible inputs $\Inputs$ is sound and complete.

\paragraph{Preservation}

We show that the following three preservation Theorems hold.

\begin{theorem}[preservation under evaluation]
      For all $e$ and $s$ such that
      $\Gamma,\Sigma\infers e:\tau$ and $\Gamma\St{}\infers s$\\
      if $e,s\evaluate e',s'$
      then $\Gamma,\Sigma\infers e':\tau$ and $\Sigma\infers s'$
      \label{thmpreseval}
\end{theorem}

Theorem~\ref{thmpreseval} is shown to be correct by induction over $e$. The full
proof can be found in the appendix.


Moving on, we show that normalisation also preserves, by showing that the
following Theorem holds.

\begin{theorem}[preservation under normalisation]
    For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Sigma\infers s$\\
    if   $e,s \stride e',s'$ then $\Gamma,\Sigma\infers e':\tau$ and $\Sigma\infers s'$
    \label{thmpresnorm}
\end{theorem}

Since this semantics makes use of the value function $\Value$, we first need to
show that this function also preserves types.

\begin{lemma}[Task value preserves]
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$\\
  if $\Value{(e,s)}=v$ then $v:\tau$
  \label{lemmavaluepreserves}
\end{lemma}

Lemma~\ref{lemmavaluepreserves} states exactly this poperty, and is proven in the
appendix by induction over $e$. This subseqently allows us to prove
Theorem~\ref{thmpresnorm}, again by induction over $e$.

This brings us finally to the type preservation property of the handling semantics.

\begin{theorem}[preservation under handling]
  For all $e$, $s$ and $i$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Sigma\infers s$\\
  if $ e,s \handle{i} e's'$ then $\Gamma,\Sigma\infers e':\tau$ and $\Sigma\infers s'$
   \label{thmpreshandle}
\end{theorem}

And again, this is proven by induction over $e$.

\subsection{Progress}

Furthermore, a well-typed term of a task type is guaranteed to progress after
normalisation, unless it is failing.

We define what we mean with progress in Theorem~\ref{thmprogressnorm}.

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$\\
  if $e,s \bar{\stride} e',s'$ then either $\Failing(e')$ or there exists an $e''$, $s''$ and $i$ such that $e',s'\handle{i}e'',s''$
  \label{thmprogressnorm}
\end{theorem}

If an expression $e$ and state $s$ are well-typed, then after normalisation, it
either fails, or there exists some input $i$ that can be handled by it.
In order to prove this Theorem to be true, we require two additional theorems.

\paragraph{Normalisation is Big-Step}

The normalisation semantics is a big-step stemantics. This would be quite
straight-forward, if we did not have to deal with state. Consider the following
example.

$(\Update l \Then \lambda x:\Bool .\ \If{x}{e}{\Fail})\And (\Edit l:=\True)$ with $s=\{l\mapsto \False\}$

When we apply S-And in order to normalise the expression above, we obtain
$(\Update l \Then \lambda x:\Bool .\ \If{x}{e}{\Fail})\And (\Edit \unit)$ with $s'=\{l\mapsto \True\}$

an expression which in fact is not normalised. The issue here lies in the fact
that $s$ gets updated, and allows the first component of $\And$ to be further
normalised, in this case to $e$. To overcome this problem, the N-Done and
N-Stride rules have been added. They ensure that normalisation is applied untill
the shared memory $s$ has become stable and no further normalisation can be
applied.

To prove that this is true, and that therefore normalisation is a big-step
semantics, we show the following theorem to be true.

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$\\
  if $e,s\normalise e',s'$ and $e',s'\normalise e'',s''$, then $e'= e''$ and $s'= s''$.
  \label{thmnormisbigstep}
\end{theorem}

An additional lemma is required.

\begin{lemma}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$\\
  if $e,s\evaluate t,s'$, $t,s'\stride t',s''$, $s=s''$ and $t',s''\evaluate t'',s'''$, then $t'=t''$ and $s''=s'''$
  \label{lemmastridedoesnotevaluate}
\end{lemma}

\paragraph{Failing}

We then show that the failing function $\Failing$ behaves as desired.

\begin{theorem}[Failing means no interaction possible]
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$\\
  and $e,s\stride e',s'$, then $\Failing(e',s')\equiv \True$, if and only if there is no $i$ such that $e',s'\handle{i}e'',s''$ for some $e''$ and $s''$.
  \label{thmfailing}
\end{theorem}

The Theorem above states that an expression $e$ and state $s$ are failing, if,
after normalisation, there exists no input that can be handled by it.
We prove the theorem to be true by induction on $e'$.

\paragraph{Proof}

We now have the ingredients to prove Theorem~\ref{thmprogressnorm}.

\begin{proof}
  Given $\Gamma,\Sigma\infers e:\Task\tau$ and $\Sigma\infers s$ and after
  normalisation $e,s \stride e',s'$, we find ourselves in either one of the
  following situations:\\

  There exists an $i$ such that $e',s'\handle{i}\_,\_$. \qed\\

  There does not exist an $i$ such that $e',s'\handle{i}\_,\_$. In this case, we
  know that $\Failing(e',s')$ must be true, since Theorem~\ref{thmnormisbigstep}
  gives us that $e',s'$ can not be normalised further and we assumed that there
  is no possible input that can be handled.
\end{proof}





\subsection{Safety of Inputs function}

\begin{theorem}
  For all $e$ and $s$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Sigma\infers s$\\
  if $i\in\Inputs{(e)}$ then $e,s\handle{i}e',s'$
  \label{thmsafetyi1}
\end{theorem}

\begin{theorem}
  For all $e$, $s$ and $i$ such that $\Gamma,\Sigma\infers e:\tau$ and $\Sigma\infers s$\\
  if $e,s\handle{i}e',s'$ then  $i\in\Inputs{(e)}$
  \label{thmsafetyi2}
\end{theorem}
\subsection{Laws}
